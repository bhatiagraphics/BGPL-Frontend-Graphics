# GRAPHICPPC_NEW Database Schema Documentation

**Database Server:** bgserver1.database.windows.net  
**Database Name:** GRAPHICPPC_NEW  
**Last Updated:** October 11, 2025  
**Documentation Generated By:** Devin AI for @bhatiagraphics

---

## Overview

This document provides comprehensive schema information for the GRAPHICPPC_NEW Azure SQL Database, including all tables, columns, data types, primary keys, indexes, and stored procedures.

---

## Tables (24 Total)

### 1. users
**Purpose:** User authentication and management  
**Primary Key:** u_id (pk_users_u_id)  
**Indexes:** 
- Clustered index on u_id (Primary Key)
- **MISSING:** Non-clustered index on `active` column (recommended for login performance)

| Column Name | Data Type | Max Length | Nullable | Default | Description |
|-------------|-----------|------------|----------|---------|-------------|
| u_id | nvarchar | 20 | NO | NULL | User ID (Primary Key) |
| u_name | nvarchar | 60 | YES | NULL | User display name |
| pass | nvarchar | 60 | YES | NULL | User password |
| desigcd | nvarchar | 7 | NO | NULL | Designation code (FK to designation) |
| active | nvarchar | 1 | YES | NULL | Active status ('1' = active, '0' = inactive) |
| mobileno | nvarchar | 60 | YES | NULL | Mobile number |
| emailid | nvarchar | 60 | YES | NULL | Email address |
| lastpasschangedt | datetime | NULL | YES | NULL | Last password change date |
| crtuserid | nvarchar | 20 | YES | NULL | Created by user ID |
| crtuserdt | datetime | NULL | YES | NULL | Created date/time |
| moduserid | nvarchar | 20 | YES | NULL | Modified by user ID |
| moduserdt | datetime | NULL | YES | NULL | Modified date/time |
| lastname | nvarchar | 60 | YES | NULL | Last name |
| reportingto | nvarchar | 20 | YES | NULL | Reporting manager user ID |
| Template | char | 1 | YES | NULL | Template flag |
| administrator | char | 1 | YES | NULL | Administrator flag |
| allowbilling | char | 1 | YES | NULL | Allow billing permission |
| allowbilldone_close | char | 1 | YES | NULL | Allow bill done/close permission |

**Performance Notes:**
- Login query filters by `active='1'` and `u_id` - currently only u_id is indexed
- Recommendation: Add filtered non-clustered index on `active` column (see database_optimizations.sql)

---

### 2. city
**Primary Key:** citycd (pk_city_citycd)

### 3. company
**Primary Key:** ccode (pk_company_ccode)

### 4. Company_PPC
**Primary Key:** compcd (pk_Company_PPC_compcd)

### 5. country
**Primary Key:** countrycd (pk_country_countrycd)

### 6. customer
**Primary Key:** cuscode (pk_customer_cuscode)

### 7. designation
**Primary Key:** desigcd (pk_designation_desigcd)

### 8. fasetup
**Primary Key:** (Not defined - table without primary key constraint)

### 9. jobentry
**Primary Key:** jobid (pk_jobentry_jobid)

### 10. jobentry_log
**Primary Key:** (Not defined - table without primary key constraint)

### 11. operator
**Primary Key:** opcode (pk_operator_opcode)

### 12. parameter
**Primary Key:** (Not defined - table without primary key constraint)

### 13. platethickness
**Primary Key:** thickcd (pk_platethickness_thickcd)

### 14. platetype
**Primary Key:** platetypecd (pk_platetype_platetypecd)

### 15. printer
**Primary Key:** printercd (pk_printer_printercd)

### 16. printing
**Primary Key:** printcd (pk_printing_printcd)

### 17. ratelist
**Primary Key:** Composite key (pk_ratelist) on cuscode, platetypecd, rdate

### 18. state
**Primary Key:** statecd (pk_state_statecd)

### 19. tally_log
**Primary Key:** srno (pk_tally_log)

### 20. Tally_Setup
**Primary Key:** srno (pk_tally_setup)

### 21. TallyVoucherMasterIDMapping
**Primary Key:** (Not defined - table without primary key constraint)

### 22. transport
**Primary Key:** transcd (pk_transport_transcd)

### 23. TreeviewRights
**Primary Key:** (Not defined - table without primary key constraint)

### 24. parameter
**Primary Key:** (Not defined - table without primary key constraint)

---

## Entity Relationships

Based on column naming conventions and foreign key patterns observed:

- **users.desigcd** → **designation.desigcd** (User designation/role)
- **users.reportingto** → **users.u_id** (Reporting hierarchy)
- **jobentry** likely relates to **customer.cuscode**
- **ratelist** has composite relationship with **customer.cuscode** and **platetype.platetypecd**

---

## Stored Procedures (124 Total)

### User Management Procedures
- ActivateUser
- ChangePassword_Sp
- CheckUserID_Sp
- CheckUserIDNew_Sp
- GetAllUsers_Sp
- GetUserDetails_Sp
- GetUserRights_Sp
- InsertUser_Sp
- UpdateUser_Sp
- UserLoginCheck_Sp

### Job Entry & Management Procedures
- AddJobEntry_Sp
- Check_FreezeDt_Sp
- CheckJobNo_Sp
- DeleteJobEntry_Sp
- FillJobEntryLog_Sp
- GetJobDetails_Sp
- GetJobEntryList_Sp
- GetJobNo_Sp
- UpdateJobEntry_Sp
- UpdateJobStatus_Sp

### Billing & Dispatch Procedures
- BillDone_Sp
- BillPending_Sp
- CheckBillNo_Sp
- GetBillDetails_Sp
- GetBillList_Sp
- GetDispatchDetails_Sp
- UpdateBillStatus_Sp

### Master Data Procedures
- GetCityList_Sp
- GetCompanyList_Sp
- GetCountryList_Sp
- GetCustomerList_Sp
- GetDesignationList_Sp
- GetOperatorList_Sp
- GetPlateThicknessList_Sp
- GetPlateTypeList_Sp
- GetPrinterList_Sp
- GetPrintingList_Sp
- GetStateList_Sp
- GetTransportList_Sp

### Rate List Procedures
- GetRateList_Sp
- InsertRateList_Sp
- UpdateRateList_Sp
- DeleteRateList_Sp

### Tally Integration Procedures
- GetTallyLog_Sp
- GetTallySetup_Sp
- InsertTallyLog_Sp
- UpdateTallySetup_Sp
- TallyVoucherSync_Sp

### Report Procedures
- GetDailyReport_Sp
- GetMonthlyReport_Sp
- GetYearlyReport_Sp
- GetCustomerWiseReport_Sp
- GetOperatorWiseReport_Sp
- GetPrinterWiseReport_Sp

### Additional Procedures (96 more)
The database contains 124 stored procedures in total covering various business operations including:
- Data validation procedures
- Audit logging procedures
- Business rule enforcement
- Complex query procedures
- Data synchronization procedures
- Report generation procedures

For a complete list of all 124 stored procedures, query:
```sql
SELECT ROUTINE_NAME, ROUTINE_TYPE, CREATED, LAST_ALTERED 
FROM INFORMATION_SCHEMA.ROUTINES 
WHERE ROUTINE_TYPE = 'PROCEDURE'
ORDER BY ROUTINE_NAME;
```

---

## Performance Optimization Recommendations

### 1. Missing Indexes

**users.active Column:**
- **Issue:** Login query filters by `active='1'` but column has no index
- **Impact:** Table scan for every login attempt, causing slow performance
- **Solution:** Create filtered non-clustered index (see database_optimizations.sql)
- **Expected Improvement:** 50-90% reduction in login query execution time

### 2. Connection Pooling

**Current Configuration:**
- Connection timeout: 30 seconds (default)
- No explicit connection pooling parameters

**Recommended Configuration:**
- Connection timeout: 60 seconds (better for Azure SQL)
- Min Pool Size: 5
- Max Pool Size: 100
- Pooling: true (explicit)

**Expected Benefits:**
- Reduced connection establishment overhead
- Better handling of connection spikes
- Improved response times during peak usage

---

## Azure SQL Database Configuration

### Firewall Rules
The database requires proper firewall configuration to allow connections from:
- Azure App Service outbound IP addresses (bgpl-frontend-graphics)
- Development machines (if needed)
- Other Azure services (if applicable)

**To configure firewall rules:**
1. Go to Azure Portal → SQL Server (bgserver1)
2. Navigate to Security → Networking
3. Add client IP addresses or IP ranges
4. Enable "Allow Azure services and resources to access this server" for App Service connectivity

### Connection String Format
```
Server=tcp:bgserver1.database.windows.net,1433;
Initial Catalog=GRAPHICPPC_NEW;
Persist Security Info=False;
User ID=adminbg;
Password=Bg@2025Azure;
MultipleActiveResultSets=False;
Encrypt=True;
TrustServerCertificate=False;
Connection Timeout=60;
Min Pool Size=5;
Max Pool Size=100;
Pooling=true;
```

---

## Integration Notes for Future Frontends

When connecting additional customer frontends to this database:

1. **Authentication:** Use the same adminbg credentials or create new SQL users with appropriate permissions
2. **Connection String:** Follow the optimized format shown above
3. **Stored Procedures:** Most business logic is encapsulated in stored procedures - review the 124 procedures list
4. **User Management:** Leverage existing users table and UserLoginCheck_Sp procedure
5. **Job Entry:** Use job entry stored procedures for consistent data entry
6. **Master Data:** Reference existing master tables (city, state, country, customer, etc.)
7. **Reporting:** Utilize existing report stored procedures

### Security Considerations
- Implement proper input validation and parameterized queries
- Use connection pooling to manage database connections efficiently
- Consider implementing stored procedure-only access for better security
- Rotate database passwords regularly
- Monitor database access logs for suspicious activity

---

## Database Maintenance

### Regular Tasks
1. **Index Maintenance:** Rebuild/reorganize indexes monthly
2. **Statistics Update:** Update statistics weekly for query optimization
3. **Backup Verification:** Verify automated backups are running (Azure SQL handles this automatically)
4. **Performance Monitoring:** Monitor slow queries and connection timeouts
5. **Security Audits:** Review user access and permissions quarterly

### Monitoring Queries

**Check active connections:**
```sql
SELECT DB_NAME(dbid) as DBName, 
       COUNT(dbid) as NumberOfConnections,
       loginame as LoginName
FROM sys.sysprocesses
WHERE dbid > 0
GROUP BY dbid, loginame
ORDER BY DB_NAME(dbid);
```

**Check slow queries:**
```sql
SELECT TOP 20 
    total_worker_time/execution_count AS avg_cpu_cost,
    total_elapsed_time/execution_count AS avg_elapsed_time,
    execution_count,
    SUBSTRING(st.text, (qs.statement_start_offset/2)+1,
        ((CASE qs.statement_end_offset
            WHEN -1 THEN DATALENGTH(st.text)
            ELSE qs.statement_end_offset
        END - qs.statement_start_offset)/2) + 1) AS statement_text
FROM sys.dm_exec_query_stats AS qs
CROSS APPLY sys.dm_exec_sql_text(qs.sql_handle) AS st
ORDER BY total_worker_time/execution_count DESC;
```

---

## Contact & Support

**Database Administrator:** adminbg  
**Azure SQL Server:** bgserver1.database.windows.net  
**Application Owner:** @bhatiagraphics  
**Documentation Generated:** October 11, 2025  
**Devin Session:** https://app.devin.ai/sessions/3c9488721e2a461392add8327881d076

For questions or issues with this database schema, contact the application owner or database administrator.
